name: Build luci-app-xray IPK

on:
  push:
    branches: [ main, master ]
  pull_request:
  release:
    types: [ published ]
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Prepare package directory
        run: |
          mkdir -p package/luci-app-xray
          rsync -av \
            --exclude='.git/' \
            --exclude='.github/' \
            --exclude='package/' \
            --exclude='.gitattributes' \
            --exclude='.gitignore' \
            ./ package/luci-app-xray/

      - name: Build with OpenWrt SDK
        uses: openwrt/gh-action-sdk@main
        with:
          arch: ramips-mt7621
          packages: luci-app-xray luci-compat

      - name: Debug: List all generated IPK files
        run: |
          echo "=== ==="
          find bin/packages -name "*.ipk" || echo ""
          echo "=== ==="
          tree bin/packages || find bin/packages -print

      - name: Upload IPK as artifact
        uses: actions/upload-artifact@v4
        with:
          name: luci-app-xray-ipk
          path: bin/packages/ramips/mt7621/packages/*.ipk
          retention-days: 30
          if-no-files-found: warn
          compression-level: 6

      - name: Upload IPK to GitHub Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: bin/packages/ramips/mt7621/packages/*.ipk
          fail_on_unmatched_files: false
